<html>
<head>
	{% load staticfiles %}
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.7.0/vis.min.js"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.7.0/vis.min.css" rel="stylesheet" type="text/css" />
	
	<style type="text/css">
	    #mynetwork {
	      width: 1000px;
	      height: 600px;
	      background: #000000;
	      border: 1px solid lightgray;
	    }
  	</style>
	<title></title>
</head>
<body>
	<div id="mynetwork"></div>
	<div class="col-lg-6" id="searchBar">
	    <div class="input-group">
	      <span class="input-group-btn">
	        <button id="clicker" class="btn btn-default" type="button">Go!</button>
	      </span>
	      <input id="search" type="text" class="form-control" placeholder="Search for...">
	    </div><!-- /input-group -->
	</div><!-- /.col-lg-6 -->

	
	<div id="displayBlock">
		
		<iframe frameborder="1" id ="showWiki"></iframe>
		<center><img id='loader' src="{% static 'ideaWeb/Pictures/Preloader_2.gif' %}"></center>
		<button id='back' type="button" class="btn btn-default" aria-label="Left Align">
	  		<span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span >  Back
		</button>
	</div>
		
	<!--<input type="text" id="search" name="search">Search!</input>-->
	<!--<button id="clicker">Submit</button>-->
    
</body>
<style type="text/css">
	html,body{ margin:0; padding:0; height:100%; width:100%; overflow: hidden;}
	#mynetwork{
		position: absolute;
	    width: 100%;
	    height: 100%;
	    left: 0;
	    top: 0;
	    display: inline-block;
	}
	#loader{
		position: absolute;
		top: 5%;
	}
	#searchBar{
		position: absolute;
		left: 50px;
		top: 50px;
		width: 20%;
	}
	#displayBlock{
		position: relative;
		left: 100%;
		width: 100%;
		height: 100%;
	}
	#showWiki{
		position: inherit;
		width: 100%;
		height: 100%;
		background: white;
	}
	#back{
		position: absolute;
		left: 50px;
		top: 10px;
		width: 8%;
		border: solid black 2px;
	}
</style>
<script type="text/javascript">
	$("#back").click(function(){
		$( "#displayBlock" ).animate({'left':'100%'}, "slow", function() {$("#loader").css({'opacity': 1})});
	})
	var nodes = new vis.DataSet([])
	var edges = new vis.DataSet([])
	var network
	var container
	var nodeTotal
	var max
	var extensions = []
	var totalNodes = {}
	var min = 10
	$("#search").focus(function(){
		$("#searchBar").css({'opacity': '1','transition': 'opacity 0.5s linear'});
	});
	$("#search").focusout(function(){
		$("#searchBar").css({'opacity': '0.1','transition': 'opacity 0.5s linear'});
	});
	$("#clicker").click(function(){
		$.ajax({
		  data: {'q':$('#search').val()},
		  url: "/ideaWeb/ajax/",
		}).done(function(result) {
		  generateGraph(result)
	});
	});
	function generateGraph(result){
		info = JSON.parse(result)
		var nodeArray = []
		var edgeArray = []
		extensions = []
		totalNodes = []
		nodeTotal = 1
		nodes = new vis.DataSet(nodeArray);
		edges = new vis.DataSet(edgeArray);
		nodes.add({id: 0, label: info.title,size: 75,group:0})
		totalNodes[info.title.toUpperCase()] = 0
		max = nodes.get(0)['size']
		extensions.push(info.save)
		branch(info,nodes.get(0),5)		
		container = document.getElementById('mynetwork');
		var data = {
		nodes: nodes,
		edges: edges
		};

		//Network Options

		var options = {
			nodes: {
				mass: 3.5,
			    shape: 'dot',
			    font: {
			        size: 32,
			        color: '#ffffff'
			    },
			    borderWidth: 2
			},
			edges: {
			    width: 5,
			    physics: true,
			    scaling:{
			      min: 1,
			      max: 150,
			  },
			  length: 200,
			},
			layout:{randomSeed:2},
		};
		network = new vis.Network(container, data, options);

		//Event Handling

		network.on("dragEnd", function (params) {
	        params.event = "[original event]";
	        nodeData = nodes.get(Number(params['nodes']))
	        if(!isInArray(nodeData['label'].toUpperCase(),extensions)){
			    $.ajax({
				  data: {'q':nodeData['label']},
				  url: "/ideaWeb/ajax/",
				}).done(function(result) {
				  	branch(info = JSON.parse(result),nodeData,5)
				});
			}
	    });
	    network.on("doubleClick",function(params){
	    	if(params['nodes'].length != 0){
		    	newNodeData = nodes.get(Number(params['nodes']))
		    	network.focus(Number(params['nodes']),{animation : true})
		    	$("#showWiki").attr({'src':'about:blank'})
			    	$( "#displayBlock" ).animate({'left':0}, "slow", function() {
			    		$("#loader").css({'opacity': 0})
				    	$("#showWiki").attr({'src':'https://en.wikipedia.org/wiki/'+newNodeData['label']}) 
				  });
	    	}
	    })
	}
	function branch(newNodes, root, size){
		var nodeArray = []
		var edgeArray = []
		var groups = []
		var connectNum = 0
		var node = 0
		var initialSize = 19
		if(!(Number(root['group']) === 0)){
			for (var i = 0; i < size; i++){
				groups.push(root['group'])
			}
		}
		else{
			for (var i = 0; i < size; i++){
				groups.push(nodeTotal+i)
			}
		}
		for (var i = 0; i < size; i++){
			nodeTotal++
			if(!totalNodes.hasOwnProperty(newNodes.edges[i][0].toUpperCase()) ){
				totalNodes[newNodes.edges[i][0].toUpperCase()] = nodeTotal
				nodeArray.push({id: nodeTotal,label:newNodes.edges[i][0], size: 15, group:groups[i]})
				edgeArray.push({from:nodeTotal, to: Number(root['id'])})
			}
			else{
				node = totalNodes[newNodes.edges[i][0].toUpperCase()]
				nodes.update({id: node, size: limit(nodes.get(node)['size'] + 20,max,initialSize)})
				edges.add({from: Number(root['id']), to: node})
			}
		}
		nodes.add(nodeArray)
		edges.add(edgeArray)
		extensions.push(root['label'].toUpperCase())
	}
	function limit(num,max,min){
		if(num > max){
			return max
		}
		else if(num < min){
			return min
		}
		else{
			return num
		}
	}
	function isInArray(value, array) {
	  return array.indexOf(value) > -1;
	}

</script>
<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
</html>
